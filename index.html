<!doctype html>
<html lang="ko">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vote Game v2</title>
    <style>
      :root {
        /* Pastel mobile tone inspired by provided image */
        --bg: #ffe7db; /* peach */
        --panel: #fff5ef; /* light card */
        --text: #2a2a2a; /* dark text */
        --muted: #7c7a7a; /* muted text */
        --accent: #2f74c0; /* primary blue */
        --accent-2: #4cb86e; /* success green */
        --danger: #ec6a6a; /* danger */
        --warning: #e4a83a; /* warning */
        --chip: #f7e6de; /* chip bg */
      }

      * {
        box-sizing: border-box;
      }
      html,
      body {
        margin: 0;
        padding: 0;
        background: var(--bg);
        color: var(--text);
        font-family:
          ui-sans-serif,
          system-ui,
          -apple-system,
          'Segoe UI',
          Roboto,
          Helvetica,
          Arial,
          'Apple Color Emoji',
          'Segoe UI Emoji';
      }

      .app {
        max-width: 420px;
        margin: 0 auto;
        min-height: 100vh;
        display: flex;
        flex-direction: column;
      }

      .header {
        position: sticky;
        top: 0;
        background: var(--bg);
        padding: 16px 20px 8px;
        z-index: 10;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 8px;
      }
      .brand-logo {
        width: 28px;
        height: 28px;
        border-radius: 8px;
        background: var(--accent);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: 700;
      }
      .brand-title {
        font-size: 20px;
        font-weight: 800;
        letter-spacing: 0.2px;
      }
      .subtle {
        color: var(--muted);
        font-size: 12px;
      }

      .content {
        flex: 1;
        padding: 8px 16px 24px;
      }

      /* Cards */
      .card {
        background: var(--panel);
        border: 1px solid rgba(0, 0, 0, 0.04);
        border-radius: 16px;
        padding: 16px;
        box-shadow: 0 2px 6px rgba(0, 0, 0, 0.04);
      }

      /* Inputs/Buttons */
      .row {
        display: flex;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
      }
      input,
      button {
        height: 42px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.08);
        background: white;
        color: var(--text);
        padding: 0 12px;
        font-size: 16px;
      }
      input {
        flex: 1;
        min-width: 160px;
      }
      input::placeholder {
        color: #b6b1ac;
      }
      button {
        background: var(--accent);
        color: white;
        cursor: pointer;
      }
      button.secondary {
        background: #e7eef9;
        color: var(--accent);
      }
      button.ghost {
        background: transparent;
        color: var(--accent);
        border-color: var(--accent);
      }
      button.danger {
        background: var(--danger);
      }
      button[disabled] {
        opacity: 0.6;
        cursor: not-allowed;
      }

      .grid-rooms {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .room-card {
        display: grid;
        gap: 8px;
        align-content: start;
        cursor: pointer;
        transition: transform 0.08s ease;
      }
      .room-card:hover {
        transform: translateY(-2px);
      }
      .room-title {
        font-weight: 700;
        font-size: 16px;
      }
      .chip {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 6px 10px;
        border-radius: 999px;
        background: var(--chip);
        color: var(--muted);
        font-size: 12px;
      }

      .section-title {
        margin: 10px 0 8px;
        color: var(--muted);
        font-size: 13px;
        font-weight: 700;
      }
      .divider {
        height: 1px;
        background: rgba(0, 0, 0, 0.06);
        margin: 12px 0;
      }

      .hidden {
        display: none !important;
      }

      /* Votes */
      .votes-grid {
        display: grid;
        gap: 12px;
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
      .vote-item h3 {
        margin: 0;
        font-size: 16px;
      }
      .count {
        color: var(--accent-2);
        font-weight: 800;
      }
      .warning {
        color: var(--warning);
        font-size: 12px;
      }

      /* Footer nav (minimal) */
      .footer {
        position: sticky;
        bottom: 0;
        background: var(--bg);
        padding: 10px 14px 16px;
        border-top: 1px solid rgba(0, 0, 0, 0.06);
      }
      .footer .row {
        justify-content: space-between;
      }

      /* Modal-ish inline create panel */
      .create-panel {
        display: grid;
        gap: 10px;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <div class="header">
        <div class="brand">
          <div class="brand-logo">B</div>
          <div>
            <div class="brand-title">Billy Vote</div>
            <div class="subtle">간단한 아이템 투표</div>
          </div>
        </div>
      </div>

      <div class="content">
        <!-- View 1: Welcome / Name -->
        <section id="view-welcome" class="card">
          <h2 style="margin: 0 0 8px">반가워요!</h2>
          <div class="subtle" style="margin-bottom: 12px">
            먼저 닉네임을 알려주세요.
          </div>
          <div class="row">
            <input id="nameInput" placeholder="닉네임" />
            <button id="goRoomsBtn">계속하기</button>
          </div>
        </section>

        <!-- View 2: Room list / create -->
        <section id="view-rooms" class="hidden">
          <div class="row" style="margin-bottom: 12px">
            <div class="card" style="flex: 1">
              <div
                class="row"
                style="justify-content: space-between; align-items: center"
              >
                <div>
                  <div class="section-title">현재 닉네임</div>
                  <div><span id="savedName" class="chip">-</span></div>
                </div>
                <button id="editNameBtn" class="secondary">이름 변경</button>
              </div>
            </div>
          </div>

          <div class="row" style="margin: 6px 0 12px">
            <button id="openCreateBtn" class="ghost">방 만들기</button>
            <button id="refreshRoomsBtn" class="secondary">새로고침</button>
          </div>

          <div
            id="createPanel"
            class="card create-panel hidden"
            style="margin-bottom: 12px"
          >
            <div class="section-title">새로운 방 이름</div>
            <div class="row">
              <input
                id="createRoomNameInput"
                placeholder="예: 회식 장소 투표"
              />
            </div>
            <div class="row" style="justify-content: flex-end">
              <button id="cancelCreateBtn" class="secondary">취소</button>
              <button id="confirmCreateBtn">생성</button>
            </div>
          </div>

          <div class="section-title">방 리스트</div>
          <div id="roomsGrid" class="grid-rooms"></div>
        </section>

        <!-- View 3: Room -->
        <section id="view-room" class="hidden">
          <div class="card" style="margin-bottom: 12px">
            <div class="row" style="justify-content: space-between">
              <div>
                <div class="section-title">방 이름</div>
                <div><span id="roomKeyLabel" class="chip">-</span></div>
              </div>
              <div>
                <div class="section-title">내 역할</div>
                <div><span id="myRoleLabel" class="chip">-</span></div>
              </div>
              <div>
                <div class="section-title">시작 상태</div>
                <div><span id="ownerReadyLabel" class="chip">-</span></div>
              </div>
            </div>
          </div>

          <div
            id="ownerControls"
            class="card hidden"
            style="margin-bottom: 12px"
          >
            <h3 style="margin-top: 0">방장 전용</h3>
            <div class="row" style="margin-bottom: 8px">
              <input id="voteItemNameInput" placeholder="아이템 이름" />
              <button id="addVoteItemBtn" class="secondary">추가</button>
            </div>
            <div class="row">
              <button id="startBtn">시작</button>
              <button id="stopBtn" class="danger">멈추기</button>
            </div>
            <div class="divider"></div>
            <div id="ownerItems" class="row" style="flex-wrap: wrap"></div>
          </div>

          <div class="card" style="margin-bottom: 12px">
            <h3 style="margin: 0 0 8px">참여자</h3>
            <div id="peaplesList" class="row" style="flex-wrap: wrap"></div>
          </div>

          <div class="card">
            <h3 style="margin: 0 0 6px">투표</h3>
            <div class="subtle" style="margin-bottom: 8px">
              방장의 <b>시작</b> 이후부터 투표할 수 있습니다. 각 아이템은 최대
              6표까지 허용됩니다.
            </div>
            <div id="votesGrid" class="votes-grid"></div>
          </div>
        </section>
      </div>

      <div class="footer">
        <div class="row">
          <button id="navToRoomsBtn" class="secondary">방 리스트</button>
          <button id="leaveRoomBtn" class="ghost">방 나가기</button>
        </div>
      </div>
    </div>

    <script>
      // ===== Config =====
      const GRAPHQL_HTTP_URL =
        sessionStorage.getItem('vg_http_url') ||
        'https://api.scheduling.co.kr/graphql';
      const GRAPHQL_WS_URL =
        sessionStorage.getItem('vg_ws_url') ||
        'wss://api.scheduling.co.kr/graphql';
      const VOTE_WS_URL =
        sessionStorage.getItem('vg_vote_ws_url') ||
        'wss://api.scheduling.co.kr/vote-game';
      const MAX_VOTES_PER_ITEM = 6;

      // ===== State =====
      const state = {
        view: 'welcome',
        name: sessionStorage.getItem('vg_name') || '',
        roomKey: sessionStorage.getItem('vg_roomKey') || '',
        roomId: null,
        myPeapleId: null,
        isOwner: false,
        ownerReady: false,
        peaples: new Map(), // id -> peaple
        voteItems: new Map(), // id -> voteItem
        roomsPollHandle: null,
        voteWs: null,
        voteWsConnected: false,
      };

      // ===== Helpers: DOM =====
      const $ = (id) => document.getElementById(id);
      function showView(name) {
        state.view = name;
        ['view-welcome', 'view-rooms', 'view-room'].forEach((v) => {
          const el = $(v);
          if (!el) return;
          el.classList.toggle('hidden', v !== name);
        });
      }
      function setTopLabels() {
        $('savedName').textContent = state.name || '-';
        $('roomKeyLabel').textContent = state.roomKey || '-';
        $('myRoleLabel').textContent = state.isOwner
          ? '방장'
          : state.myPeapleId
            ? '참가자'
            : '-';
        $('ownerReadyLabel').textContent = String(state.ownerReady);
      }

      // ===== GraphQL HTTP =====
      async function gqlRequest(query, variables) {
        const res = await fetch(GRAPHQL_HTTP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ query, variables }),
        });
        const json = await res.json();
        if (json.errors) {
          throw new Error(JSON.stringify(json.errors));
        }
        return json.data;
      }

      // ===== Queries/Mutations =====
      async function queryRooms() {
        const query = `
          query { rooms(paging: { first: 50 }) { edges { node { _id roomKey } } } }
        `;
        const data = await gqlRequest(query, {});
        return (data.rooms.edges || []).map((e) => e.node);
      }

      async function queryRoomByKey(roomKey) {
        const query = `
          query($roomKey: String!) {
            rooms(paging: {first: 1}, filter: { roomKey: { eq: $roomKey } }) {
              edges { node { _id roomKey } }
            }
          }
        `;
        const data = await gqlRequest(query, { roomKey });
        const edges = data.rooms.edges || [];
        return edges.length ? edges[0].node : null;
      }

      async function createRoom(roomKey) {
        const mutation = `
          mutation($room: CreateRoom!) {
            createOneRoom(input: { room: $room }) { _id roomKey }
          }
        `;
        const room = { _id: String(Date.now()), roomKey };
        const data = await gqlRequest(mutation, { room });
        return data.createOneRoom;
      }

      async function createPeaple({ name, roomId, isOwner }) {
        const mutation = `
          mutation($peaple: CreatePeaple!) {
            createOnePeaple(input: { peaple: $peaple }) { _id name isOwner isReady roomId voteId }
          }
        `;
        const peaple = {
          _id: String(Date.now()),
          name,
          isOwner: !!isOwner,
          isReady: false,
          roomId: String(roomId),
        };
        const data = await gqlRequest(mutation, { peaple });
        return data.createOnePeaple;
      }

      async function ensurePeaple({ name, roomId, isOwner }) {
        try {
          return await createPeaple({ name, roomId, isOwner });
        } catch (e) {
          const query = `
            query($name: String!, $roomId: String!) {
              peaples(paging: {first: 1}, filter: { and: [ { name: { eq: $name } }, { roomId: { eq: $roomId } } ] }) {
                edges { node { _id name isOwner isReady roomId voteId } }
              }
            }
          `;
          const data = await gqlRequest(query, {
            name,
            roomId: String(roomId),
          });
          const edges = data.peaples.edges || [];
          if (edges.length) return edges[0].node;
          throw e;
        }
      }

      async function updatePeaple(id, update) {
        const mutation = `
          mutation($id: ID!, $update: UpdatePeaple!) {
            updateOnePeaple(input: { id: $id, update: $update }) { _id isReady voteId }
          }
        `;
        const data = await gqlRequest(mutation, { id: String(id), update });
        return data.updateOnePeaple;
      }

      async function createVoteItem({ name, roomId }) {
        const mutation = `
          mutation($voteItem: CreateVoteItem!) {
            createOneVoteItem(input: { voteItem: $voteItem }) { _id name roomId }
          }
        `;
        const voteItem = {
          _id: String(Date.now()),
          name,
          roomId: String(roomId),
        };
        const data = await gqlRequest(mutation, { voteItem });
        return data.createOneVoteItem;
      }

      async function queryVoteItems(roomId) {
        const query = `
          query($roomId: String!) {
            voteItems(paging: { first: 50 }, filter: { roomId: { eq: $roomId } }) {
              edges { node { _id name roomId } }
            }
          }
        `;
        const data = await gqlRequest(query, { roomId: String(roomId) });
        return (data.voteItems.edges || []).map((e) => e.node);
      }

      async function queryPeaples(roomId) {
        const query = `
          query($roomId: String!) {
            peaples(paging: { first: 50 }, filter: { roomId: { eq: $roomId } }) {
              edges { node { _id name isOwner isReady voteId roomId } }
            }
          }
        `;
        const data = await gqlRequest(query, { roomId: String(roomId) });
        return (data.peaples.edges || []).map((e) => e.node);
      }

      // ===== Native WS for realtime (room scoped) =====
      function connectRoomWs() {
        if (!state.roomId) return;
        if (state.voteWs) {
          try {
            state.voteWs.close();
          } catch (_) {}
        }
        const ws = new WebSocket(VOTE_WS_URL);
        state.voteWs = ws;
        state.voteWsConnected = false;
        ws.onopen = () => {
          state.voteWsConnected = true;
          ws.send(
            JSON.stringify({
              type: 'join',
              roomId: String(state.roomId),
              name: state.name || undefined,
            }),
          );
        };
        ws.onmessage = (ev) => {
          try {
            const msg = JSON.parse(ev.data);
            if (msg.type === 'event' && msg.roomId === String(state.roomId)) {
              if (msg.event === 'refresh' || msg.event === 'presence')
                refreshAll();
            }
          } catch (e) {
            console.warn('vote-ws parse error', e);
          }
        };
        ws.onclose = () => {
          state.voteWsConnected = false;
          setTimeout(() => {
            if (state.roomId) connectRoomWs();
          }, 1500);
        };
        ws.onerror = (e) => console.warn('vote-ws error', e);
      }
      function wsBroadcast(event, payload) {
        if (!state.voteWsConnected || !state.roomId) return;
        try {
          state.voteWs.send(
            JSON.stringify({
              type: 'broadcast',
              roomId: String(state.roomId),
              event,
              payload,
            }),
          );
        } catch (_) {}
      }

      // ===== UI renders =====
      function renderRooms(rooms) {
        const grid = $('roomsGrid');
        grid.innerHTML = '';
        for (const r of rooms) {
          const div = document.createElement('div');
          div.className = 'card room-card';
          div.innerHTML = `
            <div class="room-title">${r.roomKey}</div>
            <div class="row" style="justify-content:space-between">
              <span class="chip">인원 ${r.count}</span>
              <button class="secondary" data-join="${r._id}">입장</button>
            </div>
          `;
          grid.appendChild(div);
        }
        grid.querySelectorAll('button[data-join]').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            const roomId = e.currentTarget.getAttribute('data-join');
            const roomKey = rooms.find((x) => x._id === roomId)?.roomKey;
            if (!roomKey) return;
            await enterRoom({ roomKey, create: false });
          });
        });
      }

      function renderPeaples() {
        const list = $('peaplesList');
        list.innerHTML = '';
        const arr = Array.from(state.peaples.values()).sort((a, b) =>
          a.name.localeCompare(b.name),
        );
        for (const p of arr) {
          const span = document.createElement('span');
          span.className = 'chip';
          span.textContent = p.name + (p.isOwner ? ' (방장)' : '');
          list.appendChild(span);
        }
      }

      function computeVoteCounts() {
        const counts = {};
        for (const [id] of state.voteItems) counts[id] = 0;
        for (const p of state.peaples.values())
          if (p.voteId && counts.hasOwnProperty(p.voteId))
            counts[p.voteId] += 1;
        return counts;
      }

      function renderOwnerControls() {
        const ownerPanel = $('ownerControls');
        ownerPanel.classList.toggle('hidden', !state.isOwner);
        const list = $('ownerItems');
        list.innerHTML = '';
        const items = Array.from(state.voteItems.values());
        for (const it of items) {
          const chip = document.createElement('span');
          chip.className = 'chip';
          chip.textContent = `${it.name}`;
          list.appendChild(chip);
        }
      }

      function renderVotes() {
        const canVote = !!state.ownerReady;
        const counts = computeVoteCounts();
        const grid = $('votesGrid');
        grid.innerHTML = '';
        const items = Array.from(state.voteItems.values());
        for (const it of items) {
          const cnt = counts[it._id] || 0;
          const atLimit = cnt >= MAX_VOTES_PER_ITEM;
          const card = document.createElement('div');
          card.className = 'card vote-item';
          const votedThis =
            (state.peaples.get(state.myPeapleId || '') || {}).voteId === it._id;
          card.innerHTML = `
            <h3>${it.name}</h3>
            <div>현재 표: <span class="count">${cnt}</span> / ${MAX_VOTES_PER_ITEM}</div>
            ${atLimit ? '<div class="warning">이 아이템은 6표에 도달했습니다.</div>' : ''}
            <div class="row"><button ${!canVote || atLimit ? 'disabled' : ''} data-vote="${it._id}">${votedThis ? '변경' : '투표'}</button></div>
          `;
          grid.appendChild(card);
        }
        grid.querySelectorAll('button[data-vote]').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            const voteId = e.currentTarget.getAttribute('data-vote');
            if (!state.myPeapleId) return alert('먼저 방에 입장하세요.');
            try {
              await updatePeaple(state.myPeapleId, { voteId });
              wsBroadcast('refresh', { reason: 'vote_changed' });
              await refreshAll();
            } catch (err) {
              console.error(err);
              alert('투표 실패');
            }
          });
        });
      }

      function fullRender() {
        setTopLabels();
        renderPeaples();
        renderOwnerControls();
        renderVotes();
      }

      // ===== Actions =====
      async function refreshAll() {
        if (!state.roomId) return;
        const [peaples, voteItems] = await Promise.all([
          queryPeaples(state.roomId),
          queryVoteItems(state.roomId),
        ]);
        state.peaples.clear();
        peaples.forEach((p) => state.peaples.set(p._id, p));
        state.voteItems.clear();
        voteItems.forEach((v) => state.voteItems.set(v._id, v));

        // derive my info
        if (state.myPeapleId && state.peaples.has(state.myPeapleId)) {
          state.isOwner = !!state.peaples.get(state.myPeapleId).isOwner;
        } else if (state.name) {
          const me = peaples.find((p) => p.name === state.name);
          if (me) {
            state.myPeapleId = me._id;
            sessionStorage.setItem(
              `vg_peapleId_${state.roomId}`,
              state.myPeapleId,
            );
            state.isOwner = !!me.isOwner;
          }
        }
        const owner = peaples.find((p) => p.isOwner);
        state.ownerReady = owner ? !!owner.isReady : false;

        fullRender();
      }

      async function loadRoomsList() {
        const rooms = await queryRooms();
        // attach participant counts (parallel)
        const enriched = await Promise.all(
          rooms.map(async (r) => {
            const peaples = await queryPeaples(r._id);
            return { ...r, count: peaples.length };
          }),
        );
        renderRooms(enriched);
      }

      async function enterRoom({ roomKey, create }) {
        if (!state.name) return alert('닉네임을 먼저 입력하세요.');
        try {
          let room = await queryRoomByKey(roomKey);
          if (!room) {
            if (!create) return alert('존재하지 않는 방입니다.');
            room = await createRoom(roomKey);
          }
          state.roomKey = room.roomKey;
          state.roomId = room._id;
          sessionStorage.setItem('vg_roomKey', state.roomKey);
          sessionStorage.setItem(`vg_roomId_for_${state.roomKey}`, state.roomId);

          const peaple = await ensurePeaple({
            name: state.name,
            roomId: room._id,
            isOwner: !!create,
          });
          state.myPeapleId = peaple._id;
          state.isOwner = !!peaple.isOwner;
          sessionStorage.setItem(`vg_peapleId_${state.roomId}`, state.myPeapleId);

          setTopLabels();
          await refreshAll();
          connectRoomWs();
          showView('view-room');
          wsBroadcast('refresh', { reason: 'join_or_create' });
        } catch (err) {
          console.error(err);
          alert('입장/생성 중 오류가 발생했습니다.');
        }
      }

      async function onAddVoteItem() {
        const name = $('voteItemNameInput').value.trim();
        if (!name) return;
        if (!state.roomId) return alert('먼저 방에 입장하세요.');
        try {
          await createVoteItem({ name, roomId: state.roomId });
          wsBroadcast('refresh', { reason: 'vote_item_created' });
          $('voteItemNameInput').value = '';
          await refreshAll();
        } catch (err) {
          console.error(err);
          alert('아이템 추가 실패');
        }
      }

      async function onStart() {
        if (!state.isOwner) return alert('방장만 시작할 수 있습니다.');
        if (!state.myPeapleId)
          return alert('내 Peaple ID를 확인할 수 없습니다.');
        try {
          await updatePeaple(state.myPeapleId, { isReady: true });
          wsBroadcast('refresh', { reason: 'owner_ready' });
          await refreshAll();
        } catch (err) {
          console.error(err);
          alert('시작 처리 실패');
        }
      }
      async function onStop() {
        if (!state.isOwner) return alert('방장만 멈출 수 있습니다.');
        if (!state.myPeapleId)
          return alert('내 Peaple ID를 확인할 수 없습니다.');
        try {
          await updatePeaple(state.myPeapleId, { isReady: false });
          wsBroadcast('refresh', { reason: 'owner_stop' });
          await refreshAll();
        } catch (err) {
          console.error(err);
          alert('멈춤 처리 실패');
        }
      }

      // ===== Events =====
      $('goRoomsBtn').addEventListener('click', async () => {
        const val = $('nameInput').value.trim();
        if (!val) return alert('닉네임을 입력해주세요.');
        state.name = val;
        sessionStorage.setItem('vg_name', state.name);
        $('savedName').textContent = state.name;
        showView('view-rooms');
        await loadRoomsList();
        if (state.roomsPollHandle) clearInterval(state.roomsPollHandle);
        state.roomsPollHandle = setInterval(loadRoomsList, 5000);
      });

      $('editNameBtn').addEventListener('click', () => {
        showView('view-welcome');
        $('nameInput').value = state.name || '';
      });
      $('refreshRoomsBtn').addEventListener('click', loadRoomsList);
      $('openCreateBtn').addEventListener('click', () =>
        $('createPanel').classList.remove('hidden'),
      );
      $('cancelCreateBtn').addEventListener('click', () =>
        $('createPanel').classList.add('hidden'),
      );
      $('confirmCreateBtn').addEventListener('click', async () => {
        const key = $('createRoomNameInput').value.trim();
        if (!key) return;
        $('createPanel').classList.add('hidden');
        await enterRoom({ roomKey: key, create: true });
      });

      $('addVoteItemBtn').addEventListener('click', onAddVoteItem);
      $('startBtn').addEventListener('click', onStart);
      $('stopBtn').addEventListener('click', onStop);
      $('navToRoomsBtn').addEventListener('click', async () => {
        showView('view-rooms');
        await loadRoomsList();
      });
      $('leaveRoomBtn').addEventListener('click', () => {
        showView('view-rooms');
      });

      // ===== Init =====
      (function init() {
        $('nameInput').value = state.name || '';
        $('savedName').textContent = state.name || '-';
        if (state.name) {
          showView('view-rooms');
          loadRoomsList();
          if (state.roomsPollHandle) clearInterval(state.roomsPollHandle);
          state.roomsPollHandle = setInterval(loadRoomsList, 5000);
        } else {
          showView('view-welcome');
        }
      })();
    </script>
  </body>
</html>
